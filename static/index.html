<html>
<head>
    <meta charset="utf-8">
    <title>StreamKov</title>
    <link rel="stylesheet" href="css/base.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.0.1/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.0.1/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.16/browser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.5/marked.min.js"></script>
  </head>
</head>
  <body>
    <div id="content"></div>

<script type="text/babel">
    var StuffBox = React.createClass({
      render: function() {
        return (
          <div className="stuffBox">
            <h1>StreamKov</h1>
            <ChainList url="/chains"/>
            <Sampler url="/draw/"/>
          </div>
        );
      }
    });

    var ChainList = React.createClass({
      fetchChains: function (argument) {
        $.ajax({
          url: this.props.url,
          dataType: 'json',
          cache: false,
          success: function(data) {
            data.forEach(function(part, index, arr) {
                arr[index]["chkbox"] = false;
            });
            this.setState({data: data});
          }.bind(this),
          error: function(xhr, status, err) {
            console.error(this.props.url, status, err.toString());
          }.bind(this)
        });
      },
      getInitialState: function() {
        return {data: []};
      },
      componentDidMount: function() {
        this.fetchChains();
        // setInterval(this.fetchChains(), this.props.pollInterval)
      },
      onUpdate: function (event) {
            // WARNING this illegally mutates state directly!
            // needs refactor pronto
            this.state.data.forEach(function(part, index, arr) {
                if (arr[index].name == event.target.name) {
                    arr[index].chkbox = !arr[index].chkbox
                };
            });
            this.setState({data: this.state.data});
      },
      blendChains: function (argument) {
        console.log('blendy');
        console.log(this.state.data);
        var chain_ids = this.state.data
            .filter(function (chain) {return chain.chkbox})
            .map(function (chain) {return chain.id});
        console.log(chain_ids);
        console.log(this.state.data);
        var url = '/blend/' + chain_ids;
        console.log(url);
        $.ajax({
          url: url,
          dataType: 'json',
          cache: false,
          success: function(data) {
            console.log('blended successfully!');
          },
          error: function(xhr, status, err) {
            console.error(url, status, err.toString());
          }
        });
      },
      render: function() {
        var chainNodes = this.state.data.map(function(chain) {
          return (
            <Chain
                key={chain.id}
                name={chain.name}
                chkbox={chain.chkbox}
                onUpdate={this.onUpdate}>
            </Chain>);
          }.bind(this)
        );

        return (
        <div className="chainList">
            <h1>Available models (click name to use):</h1>
              {chainNodes}
          <button onClick={this.blendChains} className='btn'>
            Blend selected models into a metamodel
          </button>
        </div>
        );
      }
    });

    var Chain = React.createClass({
      render: function() {
        return (
          <div className="chain">
          <input
            type="checkbox"
            checked={this.props.chkbox}
            onChange={this.props.onUpdate}
            name={this.props.name}/>
            <label
                for={this.props.name}
            >
              {this.props.name}
            </label>
          </div>
        );
      }
    });

    var Sampler = React.createClass({
      fetchPhrase: function (argument) {
        $.ajax({
          url: this.props.url,
          dataType: 'json',
          cache: false,
          success: function(data) {
            this.setState({text: data});
          }.bind(this),
          error: function(xhr, status, err) {
            console.error(this.props.url, status, err.toString());
          }.bind(this)
        });
      },
      handleClick: function(event) {
        this.fetchPhrase();
      },
      getInitialState: function() {
        return {text: "Load and sample"};
      },
      render: function() {
        return (
          <div className="sampler">
              <button onClick={this.handleClick} className='btn'>
                Generate a sentence
              </button>
              <p>
                {this.state.text}
              </p>
          </div>
        );
      }
    });

    ReactDOM.render(
          <StuffBox />,
      document.getElementById('content')
    );

</script>

</body>
</html>